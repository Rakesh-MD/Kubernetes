# Kubernetes Cluster Setup Guide

This guide outlines the steps to set up a Kubernetes control plane and worker nodes. Follow the steps below for each node type.

---

## Control Plane Node Setup

1. **Update and Upgrade Packages**:
   ```bash
   sudo apt update && sudo apt upgrade -y
   ```

2. **Install Necessary Tools**:
   ```bash
   sudo apt install apt-transport-https curl -y
   sudo apt install containerd -y
   ```

3. **Configure Containerd**:
   ```bash
   sudo mkdir -p /etc/containerd
   containerd config default | sudo tee /etc/containerd/config.toml > /dev/null
   sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
   sudo systemctl restart containerd
   ```

4. **Add Kubernetes Repository**:
   ```bash
   curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
   echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
   sudo apt update
   ```

5. **Install Kubernetes Components**:
   ```bash
   sudo apt install -y kubelet kubeadm kubectl
   sudo apt-mark hold kubelet kubeadm kubectl
   ```

6. **Disable Swap**:
   ```bash
   sudo swapoff -a
   sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
   ```

7. **Load Kernel Modules and Configure Networking**:
   ```bash
   sudo modprobe overlay
   sudo modprobe br_netfilter
   cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
   net.bridge.bridge-nf-call-iptables  = 1
   net.bridge.bridge-nf-call-ip6tables = 1
   net.ipv4.ip_forward                 = 1
   EOF
   sudo sysctl --system
   ```

8. **Initialize Kubernetes Control Plane**:
   ```bash
   sudo kubeadm init --pod-network-cidr=10.244.0.0/16
   ```

9. **Set Up kubectl for the Admin User**:
   ```bash
   export KUBECONFIG=/etc/kubernetes/admin.conf
   ```

10. **Deploy Pod Network**:
    ```bash
    kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
    ```

11. **Verify Cluster Status**:
    ```bash
    kubectl get nodes
    kubectl get pods --all-namespaces
    ```

12. **Optional: Create and Expose an Application**:
    ```bash
    kubectl create deployment nginx --image=nginx
    kubectl expose deployment nginx --port=80 --type=NodePort
    kubectl get svc
    ```

13. **Generate Join Command for Worker Nodes**:
    ```bash
    kubeadm token create --print-join-command
    ```

---

## Worker Node Setup

1. **Update and Upgrade Packages**:
   ```bash
   sudo apt update && sudo apt upgrade -y
   ```

2. **Install Necessary Tools**:
   ```bash
   sudo apt install apt-transport-https curl -y
   sudo apt install containerd -y
   ```

3. **Configure Containerd**:
   ```bash
   sudo mkdir -p /etc/containerd
   containerd config default | sudo tee /etc/containerd/config.toml > /dev/null
   sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
   sudo systemctl restart containerd
   ```

4. **Add Kubernetes Repository**:
   ```bash
   curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
   echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
   sudo apt update
   ```

5. **Install Kubernetes Components**:
   ```bash
   sudo apt install -y kubelet kubeadm kubectl
   sudo apt-mark hold kubelet kubeadm kubectl
   ```

6. **Disable Swap**:
   ```bash
   sudo swapoff -a
   sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
   ```

7. **Load Kernel Modules and Configure Networking**:
   ```bash
   sudo modprobe overlay
   sudo modprobe br_netfilter
   cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
   net.bridge.bridge-nf-call-iptables  = 1
   net.bridge.bridge-nf-call-ip6tables = 1
   net.ipv4.ip_forward                 = 1
   EOF
   sudo sysctl --system
   ```

8. **Join the Worker Node to the Cluster**:
   Use the `kubeadm join` command generated by the control plane:
   ```bash
   kubeadm join 172.31.16.150:6443 --token <your-token> \
       --discovery-token-ca-cert-hash sha256:<your-ca-cert-hash>
   
